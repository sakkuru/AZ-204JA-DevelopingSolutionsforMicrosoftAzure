---
lab:
    title: 'ラボ: Azure API Management を使用した多層 API の作成'
    module: 'モジュール 08: API Management の実装'
    type: 'Answer Key'
---

# ラボ: Azure のサービスを使用した多層ソリューションの作成
# 学生課題の解答

## Microsoft Azure ユーザー インターフェイス

Microsoft クラウド ツールのダイナミックな特性を考えると、このトレーニング コンテンツの開発後に Azure ユーザー インターフェイスの変更が発生する可能性があります。これらの変更により、ラボの指示と手順が一致しない場合があります。

Microsoft は、コミュニティが必要な変更を行うと、このトレーニング コースを更新します。だたし、クラウドは頻繁に更新されるため、このトレーニングの内容が更新される前に UI が変更されるかもしれません。**その場合は、変更に適宜対応して、ラボで要求されている内容を処理してください。**

## 指示

### 開始する前に

#### ラボの仮想マシンへのログイン

次の認証情報を使用して、Windows 10 仮想マシン (VM) にログインします。
    
-   ユーザー名: **管理者**

-   パスワード: **Pa55w.rd**

> **注**: 仮想ラボ環境に接続する手順は講師が説明します。

#### インストールされたアプリケーションのレビュー

Windows 10 デスクトップでタスク バーを探します。タスク バーには、この課題で使用するアプリケーションのアイコンが含まれています:
    
-   Microsoft Edge

### 演習 1: Docker コンテナー イメージを使用した Azure App Service リソースの作成

#### タスク 1: Azure portal を開く

1.  タスク バーで、**Microsoft Edge** アイコンを選択します。

1.  開いているブラウザー ウィンドウで、「Azure portal」(<https://portal.azure.com>)に移動します。

1.  サインイン ページで、Microsoft アカウントのメール アドレスを入力し、「**次へ**」 を選択します。

1.  Microsoft アカウントのパスワードを入力し、[**サインイン**] を選択します。

    > **注**: Azure portal に初めてサインインする場合は、ポータルのツアーが表示されます。ツアーをスキップしてポータルの使用を開始するには、「**開始**」 を選択します。

#### タスク 2: httpbin コンテナー イメージを使用して Azure App Service リソースを使用して Web アプリを作成する

1.  Azure potalのナビゲーション ペインで、**リソースの作成**を選択します。

1.  [**新規**] ブレードで、[**Marketplace を検索**] というテキスト ボックスを探します。

1.  検索ボックスに「**Web**」と入力し、Enter キーを押します。

1.  「**Marketplace**」 の検索結果ブレードで、「**Web アプリ**」 の結果を選択します。

1.  「**Web アプリ**」 ブレードで、「**作成**」 を選択します。

1.  2 番目の 「**Web アプリ**」 ブレードで、「**Basics**」 などのブレードのタブを見つけます。

    > **注**: 各タブは、ワークフローで新しい Web アプリを作成するためのステップを表します。いつでも 「**確認および作成**」 を選択して、残りのタブをスキップできます。

1.  「**基本**」 タブで、次の操作を実行します:
    
    1.  「**サブスクリプション**」 テキスト ボックスは既定値のままにします。
    
    1.  「**リソース グループ**」 セクションで、「**新規作成**」 を選択し、「**ApiService**」を入力し、「**OK**」 を選択します。
    
    1.  「**名前**」 テキスト ボックスに、「**httpapi*[yourname]***」を入力します。

    1.  「**発行**」 セクションで、「**Docker コンテナー**」 を選択します。

    1.  「**オペレーティング システム**」 セクションで、「**Linux**」 を選択します。

    1.  **リージョン** ドロップダウン リストで、**米国東部**のリージョンを選択します。

    1.  「**Linux Plan (米国東部)**」 セクションで、「**新規作成**」 を選択し、「**名前**」 テキスト ボックスに「**ApiPlan**」の値を入力して、「**OK**」 を選択します。

    1.  「**SKU とサイズ**」 セクションを既定値のままにします。

    1.  「**次へ: Docker**。

1.  「**Docker**」 タブで、次のアクションを実行します:

    1.  **オプション** ドロップダウン リストで、**シングル コンテナー** を選択します。

    1.  **イメージ ソース** ドロップダウン リストで、**Docker Hub** を選択します。

    1.  「**アクセス タイプ**」 ドロップダウン リストで、「**公開**」 を選択します。

    1.  「**イメージとタグ**」 テキスト ボックスに「**kennethreitz/httpbin:latest**」 と入力します。

    1.  **「確認および作成」** を選択します。

1.  「**レビューと作成**」 タブで、前の手順で選択したオプションを確認します。

1.  指定された構成を使用して Web アプリを作成するには、「**作成**」 を選択します。 

    > **注**: このラボを進める前に、作成タスクが完了するまで待ちます。

#### タスク 3: httpbin Web アプリケーションをテストする

1.  Azure potal の左側のナビゲーション ペインで、「**リソース グループ**」 を選択します。

1.  「**リソース グループ**」 ブレードから、この課題で前に作成した **ApiService** リソース グループを選択します。

1.  「**ManagedPlatform**」 ブレードから、この課題で前に作成した **httpapi*[yourname]*** Web アプリを選択します。

1.	「**Web アプリ**」 ブレードから、「**ブラウザー**」 を選択します。

1.  Web アプリケーション内で、次のアクションを実行します:

    1.  「**応答の形式**」 を選択します。 

    1.  「**GET /xml**」 を選択します。

    1.  「**試してみる**」 を選択します。

    1.  「**実行**」 を選択します。

    1.  **応答本文** および **応答ヘッダー** テキスト ボックスの値を確認します。

    1.  「**要求 URL**」 テキスト ボックスの値を確認します。

1.  Web アプリケーションのブラウザー ウィンドウを閉じます。

1.  Azure portal で **httpapi*[yourname]*** Web アプリの 「**Web アプリ**」 ブレードを見つけます。

1.  **Web アプリ** ブレードの **設定** セクションで、**プロパティ** リンクを選択します。

1.  「**プロパティ**」 セクションで、「**URL**」 テキスト ボックスの値を記録します。ラボの後半でこの値を使用して、API に対して要求を行います。

#### レビュー

この演習では、Docker Hub をソースとするコンテナー イメージを使用して、新しい Azure Web アプリを作成しました。

### 演習 2: Azure API Management を使用して API プロキシ層を構築する

#### タスク 1: API Management リソースを作成する

1.  Azure potalのナビゲーション ペインで、**リソースの作成** を選択します。

1.  **[新規]** ブレードで、[**Marketplace を検索**] というテキスト ボックスを探します。

1.  検索ボックスで、「**API** 」を入力し、Enter を選択します。

1.  **Marketplace** 検索結果ブレードから、「**API 管理**」 を選択します。

1.  「**API 管理**」 ブレードで、「**作成**」 を選択します。

1.  **API Management サービス**ブレードで、次のアクションを実行します。
    
    1.  **名前**テキスト ボックスに、「**prodapi*[yourname]***」と入力します。
    
    1.  「**サブスクリプション**」 テキスト ボックスは既定値のままにします。
    
    1.  「**リソース グループ**」 リストから、ラボで前に作成した **ApiService** グループを選択します。
    
    1.  「**場所**」 リストで、「**米国東部**」 を選択します。
    
    1.  「**組織名**」 ボックスに、「**Contoso**」を入力します。
    
    1.  [**管理者のメール アドレス**] ボックスは、既定値のままにしておきます。
    
    1.  「**価格層**」 リストで、「**消費 (99.9 SLA, %)**」 を選択します。
    
    1.  「**作成**」 を選択します。

    > **注**: 課題を進める前に、作成タスクが完了するまで待ちます。

#### タスク 2: 新しい API の定義

1.  Azure potal の左側のナビゲーション ペインで、「**リソース グループ**」 を選択します。

1.  「**リソース グループ**」 ブレードから、この課題で前に作成した **ApiService** リソース グループを選択します。

1.  「**ApiService**」 ブレードから、この課題で前に作成した **prodapi*[yourname]*** API Management アカウントを選択します。

1.  「**API Management Service**」 ブレードの 「**API Management**」 セクションで、「**APIs**」 を選択します。

1.  「**新しい API を追加**」 セクションで、「**空白 API**」 を選択します。

1.  「**空白の API を作成する**」 ウィンドウで、次のアクションを実行します。
    
    1.  「**名前の表示**」 フィールドに「**HTTPBin API**」を入力します。
    
    1.  **名前** テキスト ボックスに、「**httpbin-api**」を入力します。
    
    1.  「**Web サービスの URL**」 テキストボックスに、このラボで前にコピーした Web アプリの URL を入力します。

        >**注意**: URL のコピー方法によっては、有効な URL 値を作成するために "http://" プレフィックスを追加する必要があります。

    1.  **API URL suffix**ボックスを空のままにします。

    1.  「**作成**」 を選択します。

    > **注**: 新しい API の作成が完了するのを待ちます。

1.  「**デザイン**」 タブから、「**操作の追加**」 を選択します。

1.  「**操作の追加**」 セクションで、次の操作を実行します。
    
    1.  「**表示名**」 テキスト ボックスに、「**Echo Headers**」 を入力します。
    
    1.  **名前**テキスト ボックスに、「**echo-headers**」 を入力します。
    
    1.  **URL** リストで **GET** を選択します。

    1.  **URL** テキスト ボックスに、 「**/**」 と入力します。
    
    1.  「**保存**」 を選択します。

1.	「**デザイン**」 タブに戻り、 操作の一覧で 「**すべての操作**」 を選択します。

1.	**すべての操作**の**設計** セクション で、 **受信処理** タイルを検索し、**ポリシーを追加** を選択します。

1.	**受信ポリシーの追加** セクションで、**ヘッダーの設定** タイルを選択します。

1.	**受信処理、ヘッダーの設定** セクションで、次のアクションを実行します。
    
    1.  **名前** テキスト ボックスに、「**source**」 を入力します。
    
    1.  「**値**」 テキスト ボックスで、一覧を選択し、「**値の追加**」 を選択して、「**azure-api-mgmt**」を入力します。
    
    1.  「**アクション**」 リストで 「**追加**」 を選択します。
    
    1.  「**保存**」 を選択します。

1.	**デザイン**タブに戻り、操作の一覧で、**ヘッダーのエコー** を選択します。

1.	「**ヘッダーのエコー**」 の 「**デザイン**」 セクションで、「**バックエンド**」 タイルを見つけて、鉛筆アイコンを選択します。

1.  **バックエンド** セクションで、次の操作を実行します:

    1.  **サービス URL** セクションで、**上書き** チェック ボックスを選択します。

    1.  **サービス URL** テキスト ボックスで、 値**/ヘッダー** を現在の値にアペンドします。

        >**注意**: たとえば、現在の値が **http://httpapi*[yourname]*.azurewebsites.net** の場合、新しい値は **http://httpapi*[yourname]*.azurewebsites.net/headers となります**

    1.  「**保存**」 を選択します。

1.	**デザイン** タブに戻り、操作の一覧で、**ヘッダーのエコー** を選択します。

1.	「**テスト**」 タブから、「**ヘッダーのエコー**」 操作を選択します。

1.	「**ヘッダーのエコー**」 セクションで、「**送信**」 を選択します。

1.	API 要求の結果を確認します。

    > **注意**: 応答にエコーされる要求の一部として送信されるヘッダーが多数あることを監視します。具体的には、このタスクの一部として作成した新しい **ソース** ヘッダーに注目します。

1.	「**デザイン**」 タブを選択し、操作の一覧に戻ります。

#### タスク 3: API 応答の操作

1.  「**デザイン**」 タブから、「**操作の追加**」 を選択します。

1.  「**操作の追加**」 セクションで、次の操作を実行します。
    
    1.  **表示名**テキスト ボックスに、「**Get Legacy Data**」 と入力します。
    
    1.  「**名前**」 テキスト ボックスに、 「**get-legacy-data**」 を入力します。
    
    1.  **URL** リストで **GET** を選択します。
    
    1.  「**URL**」 テキスト ボックスに、「**/xml**」を入力します。
    
    1.  「**保存**」 を選択します。

1.  **デザイン** タブに戻り、操作の一覧で、**レガシ データの取得** を選択します。

1.	「**テスト**」 タブから、**レガシ データの取得** 操作を選択します。

1.	「**レガシ データの取得**」 セクションで、「**送信**」 を選択します。

1.	API 要求の結果を確認します。

    > **注**: この時点で、結果は XML 形式となります。

1.	**デザイン** タブに戻り、操作の一覧で、**レガシ データの取得** を選択します。

1.  **レガシ データの取得** 操作の 「**デザイン**」 セクションで、「**送信処理**」 タイルを検索し、「**ポリシーを追加**」 を選択します。

1.  「**送信ポリシーの追加**」 セクションで、「**その他のポリシー**」 タイルを選択します。

1.  ポリシー コード エディターで、次の XML コンテンツのブロックを検索します。

    ```
    <outbound>
        <base />
    </outbound>
    ```

1.	XML のブロックを次の XML に置き換えます。

    ```
    <outbound>
        <base />
        <xml-to-json kind="direct" apply="always" consider-accept-header="false" />
    </outbound>
    ```

1.  ポリシー コード エディターで、「**保存**」 を選択します。

1.  **デザイン** タブに戻り、操作の一覧で、**レガシ データの取得** を選択します。

1.	「**テスト**」 タブから、**レガシ データの取得** 操作を選択します。

1.	「**レガシ データの取得**」 セクションで、「**送信**」 を選択します。

1.	API 要求の結果を確認します。

    > **注意**: 新しい結果は、JavaScript Object Notation (JSON) 形式です。

1.  「**HTTP 応答**」 セクションで、次の操作を実行します。

    1.  「**トレース**」 を選択します。 

    1.  「**バックエンド**」 および 「**送信**」 テキスト ボックスの内容を確認します。

#### レビュー

この演習では、App Service リソースとクエリを実行する開発者との間にプロキシ層を構築しました。

### エクササイズ 3: サブスクリプションのクリーンアップ 

#### タスク 1: Azure Cloud Shell を開く

1.  ポータルで、**Cloud Shell** アイコンを選択して新しいシェル インスタンスを開きます。

1.  **Cloud Shell** コマンド プロンプトのポータルの下部にある次のコマンドを入力し、Enter キーを押してサブスクリプション内のすべてのリソース グループを一覧表示します。

    ```
    az group list
    ```

1.  次のコマンドを入力し、Enter キーを選択して、リソース グループを削除する可能性のあるコマンドの一覧を確認します。

    ```
    az group delete --help
    ```

#### タスク 2: リソース グループを削除する

1.  次のコマンドを入力し、Enter キーを押して **ApiService** リソース グループを削除します。

    ```
    az group delete --name ApiService --no-wait --yes
    ```
    
1.  ポータルの Cloud Shell ペインを閉じます。

#### タスク 3: アクティブなアプリケーションを閉じる

-   現在実行中の Microsoft Edge アプリケーションを閉じます。

#### レビュー

この実習では、この課題で使用するリソース グループを削除することで、サブスクリプションをクリーンアップしました。